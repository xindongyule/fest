<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚨 紧急密码重置工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 700px;
            width: 100%;
            border: 3px solid #ff6b6b;
        }
        
        .warning-header {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .warning-header h1 {
            margin: 0 0 10px 0;
            color: #dc3545;
            font-size: 24px;
        }
        
        .instructions {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .instructions h3 {
            margin: 0 0 15px 0;
            color: #dc3545;
        }
        
        .instructions ol {
            margin: 0;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        input[type="password"]:focus {
            outline: none;
            border-color: #dc3545;
        }
        
        button {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }
        
        .result {
            margin-top: 20px;
            padding: 16px;
            border-radius: 8px;
            display: none;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .security-note {
            background: #e2e3e5;
            border-left: 4px solid #6c757d;
            padding: 16px;
            margin-top: 25px;
        }
        
        .security-note h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .domain-check {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .domain-check.safe {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .domain-check.unsafe {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="warning-header">
            <h1>🚨 紧急密码重置工具</h1>
            <p><strong>警告：</strong>此工具具有管理员权限，仅在紧急情况下使用！</p>
        </div>
        
        <div id="domainCheck" class="domain-check">
            <strong>🔍 正在验证当前域名...</strong>
        </div>
        
        <div class="instructions">
            <h3>⚠️ 使用前须知：</h3>
            <ol>
                <li><strong>仅限紧急情况使用</strong>：当无法通过正常途径修改密码时</li>
                <li><strong>需要物理访问权限</strong>：确保您有权访问此网站的管理后台</li>
                <li><strong>使用后立即删除</strong>：完成重置后应立即删除此文件</li>
                <li><strong>设置强密码</strong>：新密码应包含大小写字母、数字和特殊字符</li>
                <li><strong>验证重置结果</strong>：重置后请立即测试新密码是否有效</li>
            </ol>
        </div>
        
        <div id="toolContent" style="display: none;">
            <div class="form-group">
                <button onclick="diagnoseProblem()">🔍 诊断密码状态</button>
                <button onclick="testAccess()">🧪 测试当前密码</button>
            </div>
            
            <div id="diagnosisResult" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 16px; margin: 20px 0; font-family: monospace; font-size: 14px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; display: none;"></div>
            
            <div class="form-group">
                <label for="newPassword">🔑 设置新密码：</label>
                <input type="password" id="newPassword" placeholder="输入安全的新密码（至少8位）">
                <small style="color: #666; font-size: 12px;">建议包含大写字母、小写字母、数字和特殊字符</small>
            </div>
            
            <div class="form-group">
                <button onclick="emergencyReset()">🚨 紧急重置密码</button>
                <button onclick="resetToDefault()" class="btn-danger">🔄 恢复默认密码</button>
            </div>
            
            <div id="result" class="result"></div>
        </div>
        
        <div class="security-note">
            <h4>🛡️ 安全提醒：</h4>
            <ul>
                <li>此工具绕过了正常的身份验证流程</li>
                <li>使用完毕后请立即从服务器删除此文件</li>
                <li>建议重命名文件名为随机字符串以增加安全性</li>
                <li>定期更换管理员密码，使用密码管理器生成强密码</li>
            </ul>
        </div>
    </div>

    <script>
        // 域名安全检查
        function checkDomainSafety() {
            const domain = window.location.hostname;
            const isLocalhost = domain === 'localhost' || domain === '127.0.0.1' || domain.startsWith('192.168.') || domain.startsWith('10.') || domain.includes('local');
            const domainCheckDiv = document.getElementById('domainCheck');
            const toolContent = document.getElementById('toolContent');
            
            if (isLocalhost) {
                domainCheckDiv.className = 'domain-check safe';
                domainCheckDiv.innerHTML = `
                    <strong>✅ 本地环境检测</strong><br>
                    当前域名: ${domain}<br>
                    这是一个相对安全的本地环境，可以继续使用此工具。
                `;
                toolContent.style.display = 'block';
            } else {
                domainCheckDiv.className = 'domain-check unsafe';
                domainCheckDiv.innerHTML = `
                    <strong>⚠️ 生产环境警告</strong><br>
                    当前域名: ${domain}<br>
                    <strong style="color: #dc3545;">建议不要在生产环境中使用此工具！</strong><br>
                    <button onclick="confirmProductionUse()" style="margin-top: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">我了解风险，继续使用</button>
                `;
            }
        }
        
        function confirmProductionUse() {
            if (confirm('您确定要在生产环境中使用此工具吗？\n\n这可能带来安全风险，建议：\n1. 使用完毕后立即删除此文件\n2. 检查服务器访问日志\n3. 更换管理员密码\n\n点击确定继续，取消返回')) {
                document.getElementById('toolContent').style.display = 'block';
            }
        }
        
        // 显示结果
        function showResult(message, type = 'error') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = message.replace(/\n/g, '<br>');
            resultDiv.style.display = 'block';
            
            // 自动滚动到结果
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 诊断问题
        function diagnoseProblem() {
            const diagnosisDiv = document.getElementById('diagnosisResult');
            
            let diagnosis = '📊 密码存储诊断：\n\n';
            
            const adminCredentials = localStorage.getItem('admin_credentials');
            const securityConfig = localStorage.getItem('security_config');
            
            if (adminCredentials) {
                try {
                    const creds = JSON.parse(adminCredentials);
                    const password = atob(creds.password);
                    diagnosis += `✅ 登录凭据: 用户名="${creds.username}", 密码="${password}"\n`;
                } catch (e) {
                    diagnosis += `❌ 登录凭据解析失败: ${e.message}\n`;
                }
            } else {
                diagnosis += '❌ 未找到登录凭据\n';
            }
            
            if (securityConfig) {
                try {
                    const config = JSON.parse(securityConfig);
                    if (config.password) {
                        diagnosis += `✅ 安全配置: 密码="${config.password.current}", 修改时间=${new Date(config.password.lastChanged).toLocaleString()}\n`;
                    } else {
                        diagnosis += '⚠️ 安全配置存在但无密码信息\n';
                    }
                } catch (e) {
                    diagnosis += `❌ 安全配置解析失败: ${e.message}\n`;
                }
            } else {
                diagnosis += '❌ 未找到安全配置\n';
            }
            
            // 认证状态
            const authKeys = ['adminLoginTime', 'adminToken', 'lastActivity'];
            diagnosis += '\n🔐 当前认证状态:\n';
            authKeys.forEach(key => {
                const value = localStorage.getItem(key);
                diagnosis += `   ${key}: ${value ? '存在' : '不存在'}\n`;
            });
            
            diagnosisDiv.textContent = diagnosis;
            diagnosisDiv.style.display = 'block';
        }
        
        // 测试访问
        function testAccess() {
            const password = prompt('请输入要测试的密码:');
            if (!password) return;
            
            try {
                const storedCredentials = localStorage.getItem('admin_credentials');
                if (!storedCredentials) {
                    showResult('❌ 未找到存储的凭据', 'error');
                    return;
                }
                
                const credentials = JSON.parse(storedCredentials);
                const decodedPassword = atob(credentials.password);
                
                if (password === decodedPassword) {
                    showResult(`✅ 密码验证成功！密码 "${password}" 有效。`, 'success');
                } else {
                    showResult(`❌ 密码验证失败！\n存储的密码: "${decodedPassword}"\n测试的密码: "${password}"`, 'error');
                }
            } catch (error) {
                showResult(`❌ 验证过程出错: ${error.message}`, 'error');
            }
        }
        
        // 紧急重置
        function emergencyReset() {
            const newPassword = document.getElementById('newPassword').value;
            
            if (!newPassword) {
                showResult('❌ 请先输入新密码！', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showResult('❌ 密码长度至少8位！', 'error');
                return;
            }
            
            if (!confirm(`🚨 紧急重置确认\n\n您即将将管理员密码重置为: "${newPassword}"\n\n此操作将：\n• 覆盖当前密码\n• 清除所有登录会话\n• 需要重新登录\n\n确定继续吗？`)) {
                return;
            }
            
            try {
                // 更新登录凭据
                const credentials = {
                    username: 'admin',
                    password: btoa(newPassword)
                };
                localStorage.setItem('admin_credentials', JSON.stringify(credentials));
                
                // 更新安全配置
                let securityConfig = {};
                try {
                    const existing = localStorage.getItem('security_config');
                    if (existing) {
                        securityConfig = JSON.parse(existing);
                    }
                } catch (e) {
                    console.log('创建新的安全配置');
                }
                
                securityConfig.password = {
                    current: newPassword,
                    lastChanged: Date.now(),
                    strength: 'good',
                    resetBy: 'emergency-tool',
                    resetTime: new Date().toISOString()
                };
                localStorage.setItem('security_config', JSON.stringify(securityConfig));
                
                // 清除认证会话
                const authKeys = ['adminLoginTime', 'adminToken', 'lastActivity', 'admin_session'];
                authKeys.forEach(key => localStorage.removeItem(key));
                
                showResult(`🎉 紧急重置成功！\n\n新密码: "${newPassword}"\n重置时间: ${new Date().toLocaleString()}\n\n⚠️ 安全提醒：\n• 请立即删除此工具文件\n• 使用新密码登录管理后台\n• 检查是否有其他人访问过此工具`, 'success');
                
                // 清空输入框
                document.getElementById('newPassword').value = '';
                
                // 3秒后提示跳转
                setTimeout(() => {
                    if (confirm('重置完成！\n\n点击确定跳转到登录页面，取消继续使用工具。')) {
                        window.location.href = 'login.html';
                    }
                }, 3000);
                
            } catch (error) {
                showResult(`❌ 重置失败: ${error.message}`, 'error');
            }
        }
        
        // 重置为默认
        function resetToDefault() {
            if (!confirm('🔄 恢复默认密码确认\n\n这将把密码重置为: "admin123"\n\n确定继续吗？')) {
                return;
            }
            
            const defaultPassword = 'admin123';
            
            try {
                const credentials = {
                    username: 'admin',
                    password: btoa(defaultPassword)
                };
                localStorage.setItem('admin_credentials', JSON.stringify(credentials));
                
                let securityConfig = {};
                try {
                    const existing = localStorage.getItem('security_config');
                    if (existing) {
                        securityConfig = JSON.parse(existing);
                    }
                } catch (e) {
                    console.log('创建新的安全配置');
                }
                
                securityConfig.password = {
                    current: defaultPassword,
                    lastChanged: Date.now(),
                    strength: 'weak',
                    resetBy: 'emergency-tool-default',
                    resetTime: new Date().toISOString()
                };
                localStorage.setItem('security_config', JSON.stringify(securityConfig));
                
                const authKeys = ['adminLoginTime', 'adminToken', 'lastActivity', 'admin_session'];
                authKeys.forEach(key => localStorage.removeItem(key));
                
                showResult(`🔄 已恢复默认密码！\n\n用户名: admin\n密码: admin123\n\n⚠️ 警告：默认密码安全性较低，请尽快修改！`, 'success');
                
            } catch (error) {
                showResult(`❌ 恢复失败: ${error.message}`, 'error');
            }
        }
        
        // 页面加载时检查域名
        window.addEventListener('load', checkDomainSafety);
        
        // 防止意外关闭
        window.addEventListener('beforeunload', function(e) {
            e.preventDefault();
            e.returnValue = '确定要离开此页面吗？未保存的操作将丢失。';
        });
    </script>
</body>
</html> 